# Система синхронизации данных с внешним API

## Обзор

Реализована полная система синхронизации данных с внешним API Strattera, включающая:

1. **Автоматическую синхронизацию каждые 5 минут**
2. **Сохранение данных в PostgreSQL**
3. **API endpoints для фронтенда**
4. **Обновление пользовательских изменений**

## Компоненты системы

### 1. Синхронизация с внешним API

**Внешние API endpoints:**
- Заказы: `https://strattera.tgapp.online/api/v1/orders`
- Товары: `https://strattera.tgapp.online/api/v1/products`
- Авторизация: `Authorization: 8cM9wVBrY3p56k4L1VBpIBwOsw`

**Реализованные функции:**
- `syncOrders()` - синхронизация заказов
- `syncProducts()` - синхронизация товаров
- `autoSyncAll()` - автоматическая синхронизация всех данных

### 2. Cron задачи

**Файл:** `backend/src/utils/cronJobs.ts`

- Запускается автоматически при старте сервера
- Синхронизация каждые 5 минут (`*/5 * * * *`)
- Первая синхронизация выполняется сразу при запуске
- Graceful shutdown при остановке сервера

### 3. База данных (PostgreSQL + Prisma)

**Таблицы:**
- `orders` - заказы с полями из внешнего API
- `order_items` - товары в заказах
- `products` - каталог товаров
- `product_trends` - аналитика по товарам

**Особенности:**
- Использование `upsert` для обновления существующих записей
- Сохранение `externalId` для связи с внешним API
- Автоматическое обновление `updatedAt`

### 4. API endpoints для фронтенда

#### Получение данных:
- `GET /api/orders` - список заказов из БД
- `GET /api/orders/:id` - детали заказа
- `GET /api/orders/stats` - статистика заказов
- `GET /api/products` - список товаров из БД

#### Синхронизация (ручная):
- `POST /api/sync-orders` - синхронизировать заказы
- `POST /api/sync-products` - синхронизировать товары

#### Обновление данных:
- `PUT /api/orders/:id/status` - обновить статус заказа
- `PUT /api/orders/:id` - обновить данные заказа
- `PUT /api/products/:id/stock` - обновить остаток товара
- `PUT /api/products/:id/price` - обновить цену товара
- `PUT /api/products/:id/cost` - обновить себестоимость
- `PUT /api/products/:id/analytics` - обновить аналитику

### 5. Обработка пользовательских изменений

Все изменения, сделанные пользователем через фронтенд, сохраняются в БД и не перезаписываются при синхронизации:

- Изменения статусов заказов
- Обновление цен и остатков товаров
- Добавление себестоимости
- Скрытие товаров
- Аналитические данные

## Запуск системы

### 1. Установка зависимостей:
```bash
cd backend
npm install
```

### 2. Настройка базы данных:
```bash
# Создать .env файл с DATABASE_URL
cp .env.example .env

# Применить миграции
npx prisma migrate dev

# Сгенерировать Prisma Client
npx prisma generate
```

### 3. Запуск сервера:
```bash
# Development
npm run dev

# Production
npm run build
npm start
```

## Мониторинг

При запуске сервера в консоли отображается:
- Статус cron задач
- Время следующей синхронизации
- Результаты каждой синхронизации
- Количество обработанных записей

## Обработка ошибок

- Синхронизация продолжается даже при ошибках отдельных записей
- Все ошибки логируются в консоль
- API возвращает детальную информацию об ошибках
- При недоступности внешнего API используются данные из БД

## Производительность

- Пакетная обработка записей
- Использование `upsert` для минимизации запросов
- Кэширование данных на уровне БД
- Асинхронная обработка

## Безопасность

- Авторизационный токен хранится в переменных окружения
- CORS настроен для разрешенных доменов
- Helmet для защиты от распространенных уязвимостей
- Валидация входных данных 
